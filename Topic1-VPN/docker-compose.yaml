# ============================================
# Mihomo VPN 配置文件
# ============================================
#
# 【使用说明】
# 1. 启动服务：docker compose up -d
# 2. 停止服务：docker compose down
# 3. 查看日志：docker logs mihomo 或 docker logs metacubexd
# 4. 重启服务：docker restart mihomo metacubexd
#
# 【访问方式】
# - Web管理面板：http://你的服务器IP:8080
# - Mihomo API：http://你的服务器IP:9090
#
# 【首次配置 Web 面板】
# 打开 http://你的服务器IP:8080 后需要填写：
#   - Endpoint URL: http://你的服务器IP:9090
#     (如果在本机访问可以用 http://localhost:9090)
#   - Secret: 留空不填
#     (如需设置密码，请在 config/config.yaml 中添加 secret: '你的密码')
#
# 【代理设置】
# - 代理端口：7890 (HTTP + SOCKS5 混合端口)
# - 系统代理设置：http://127.0.0.1:7890
#
# ============================================

version: '3.8'

services:
  # --- Mihomo (Clash Core) 核心服务 ---
  # 负责实际的代理转发和规则匹配
  mihomo:
    image: metacubex/mihomo:latest
    container_name: mihomo
    restart: always
    network_mode: "host" # 强烈建议：代理软件使用 host 模式性能最好，且能处理复杂的网络流量
    volumes:
      - ./config/config.yaml:/root/.config/mihomo/config.yaml # 挂载配置文件
      # - ./ui:/root/.config/mihomo/ui # 如果你想把 UI 放在核心里托管(可选)
    cap_add:
      - NET_ADMIN # 必须：赋予网络管理权限
      - SYS_MODULE # 可选：如果需要加载内核模块
      - SYS_TIME # 可选：设置系统时间
    environment:
      - TZ=Asia/Shanghai

  # --- Metacubexd (Web UI) 管理面板 ---
  # 提供可视化的代理管理界面，通过浏览器访问
  metacubexd:
    image: ghcr.io/metacubex/metacubexd:latest
    container_name: metacubexd
    restart: always
    ports:
      - "8080:80" # 外部访问端口:容器内部端口 - 通过 http://IP:8080 访问面板
    # 注意：WebUI 本身是无状态的静态网页，它通过浏览器连接到 9090 端口的 Mihomo API
    # 因此 config.yaml 中的 external-controller 必须设置为 0.0.0.0:9090 才能远程访问
